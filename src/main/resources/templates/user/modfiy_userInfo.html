<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>회원정보 수정</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
  <style>
    body{background:#f8f9fa}
    .wrap{max-width:720px;margin:36px auto}
  </style>
</head>
<body>
<div class="wrap">
  <h3 class="mb-3 fw-bold">회원정보 수정</h3>

  <form th:action="@{/account/profile}" method="post" id="editForm"
        class="border p-4 rounded bg-white needs-validation" novalidate>
    <input type="hidden" th:name="${_csrf?.parameterName}" th:value="${_csrf?.token}"/>

    <!-- 아이디 (수정불가) -->
    <div class="mb-3">
      <label class="form-label">아이디</label>
      <input class="form-control" th:value="${user.userId}" readonly>
    </div>

    <!-- 이름 -->
    <div class="mb-3">
      <label for="userName" class="form-label">이름</label>
      <input id="userName" name="userName" class="form-control" required
             th:value="${user.userName}">
      <div class="invalid-feedback">이름을 입력하세요.</div>
    </div>

    <!-- 비밀번호 변경 (선택) -->
    <div class="row g-2 mb-1">
      <div class="col-md-6">
        <label for="newPassword" class="form-label">새 비밀번호(선택)</label>
        <div class="input-group">
          <input type="password" id="newPassword" name="newPassword" class="form-control" minlength="8"
                 placeholder="변경 시 8자 이상">
          <button class="btn btn-outline-secondary" type="button"
                  onclick="togglePassword('newPassword', this)">👁</button>
        </div>
        <div class="form-text">비워두면 변경하지 않습니다.</div>
      </div>
      <div class="col-md-6">
        <label for="newPassword2" class="form-label">새 비밀번호 확인</label>
        <div class="input-group">
          <input type="password" id="newPassword2" class="form-control" minlength="8">
          <button class="btn btn-outline-secondary" type="button"
                  onclick="togglePassword('newPassword2', this)">👁</button>
        </div>
        <div id="pwHelp" class="invalid-feedback">비밀번호가 서로 다릅니다.</div>
      </div>
    </div>

    <!-- 이메일 -->
    <div class="mb-3">
      <label for="userEmail" class="form-label">이메일</label>
      <input type="email" id="userEmail" name="userEmail" class="form-control" required
             th:value="${user.userEmail}">
      <div class="invalid-feedback">이메일 형식을 확인하세요.</div>
    </div>

    <!-- 휴대폰 -->
    <div class="mb-3">
      <label for="userPhone" class="form-label">휴대폰 번호</label>
      <input id="userPhone" name="userPhone" class="form-control" inputmode="numeric" maxlength="13"
             placeholder="010-1234-5678" th:value="${user.userPhone}">
      <div class="form-text">숫자만 입력하면 자동으로 하이픈이 들어갑니다.</div>
    </div>

    <!-- 생년월일 -->
    <div class="mb-3">
      <label for="birthDate" class="form-label">생년월일</label>
      <input type="date" id="birthDate" name="birthDate" class="form-control"
             th:value="${user.birthDate != null ? #temporals.format(user.birthDate, 'yyyy-MM-dd') : ''}"
>
      <div class="form-text">선택 시 표시: <span id="birthPreview">-</span></div>
    </div>

    <!-- 주소: 기본 + 상세 (서버에서 합쳐 저장) -->
    <div class="mb-2">
      <label class="form-label">주소</label>
      <div class="input-group mb-2">
        <input type="text" id="userAddress" name="userAddress" class="form-control" required
               placeholder="(우편번호) 기본주소"
               th:value="${user.userAddress}">
        <button type="button" class="btn btn-outline-secondary" onclick="openPostcode()">주소 검색</button>
        <div class="invalid-feedback">기본주소를 입력하세요.</div>
      </div>
<!--       <input type="text" id="detailAddress" name="detailAddress" class="form-control" -->
<!--              placeholder="상세주소 (동/호 등)" -->
<!--              th:value="${user.detailAddress}"> -->
<!--       <div class="form-text">저장은 서버에서 ‘기본 + 상세’ 한 줄로 합쳐집니다.</div> -->
    </div>

    <!-- 출금계좌(선택) -->
    <div class="row g-2 mb-3">
      <div class="col-md-4">
        <label for="userBank" class="form-label">은행</label>
        <select id="bankName" name="bankName" class="form-select" th:value="${user.bankName}">
          <option value="">선택</option>
          <option>국민</option><option>우리</option><option>신한</option>
          <option>하나</option><option>농협</option><option>카카오뱅크</option>
        </select>
      </div>
      <div class="col-md-8">
        <label for="userBankAccount" class="form-label">계좌번호</label>
        <input id="userBankAccount" name="userBankAccount" class="form-control"
               placeholder="숫자만 입력" th:value="${user.userBankAccount}">
      </div>
    </div>

    <div class="d-flex gap-2">
      <a th:href="@{/user/mypage}" class="btn btn-outline-secondary w-50">취 소</a>
      <button class="btn btn-primary w-50" type="submit">저 장</button>
    </div>
  </form>
</div>

<script>
  // 비번 토글
  function togglePassword(id, btn){
    const el = document.getElementById(id);
    const to = el.type === 'password' ? 'text' : 'password';
    el.type = to; btn.textContent = (to==='text' ? '@' : '👁');
  }

  // 휴대폰 자동 하이픈
  const phone = document.getElementById('userPhone');
  phone?.addEventListener('input', ()=>{
    let v = phone.value.replace(/\D/g,'').slice(0,11);
    if(v.length>7) v = v.replace(/(\d{3})(\d{4})(\d{1,4})/,'$1-$2-$3');
    else if(v.length>3) v = v.replace(/(\d{3})(\d{1,4})/,'$1-$2');
    phone.value = v;
  });

  // 생일 프리뷰
  const birth = document.getElementById('birthDate');
  const birthPreview = document.getElementById('birthPreview');
  function refreshBirth(){ birthPreview.textContent = birth.value ? birth.value.replaceAll('-', '.') : '-'; }
  birth?.addEventListener('change', refreshBirth); refreshBirth();

  // 다음 우편번호
  function openPostcode() {
    new daum.Postcode({
      oncomplete: function(data) {
        const base = (data.userSelectedType === 'R' ? data.roadAddress : data.jibunAddress) || '';
        document.getElementById('baseAddress').value = `(${data.zonecode}) ${base}`.trim();
        document.getElementById('detailAddress').focus();
      }
    }).open();
  }

  // 제출 검증 (비번 일치)
  (function(){
    const form = document.getElementById('editForm');
    const pw1 = document.getElementById('newPassword');
    const pw2 = document.getElementById('newPassword2');

    form.addEventListener('submit', (e)=>{
      if(!form.checkValidity()){ e.preventDefault(); e.stopPropagation(); }
      if(pw1.value || pw2.value){
        if(pw1.value.length < 8 || pw1.value !== pw2.value){
          e.preventDefault(); e.stopPropagation();
          pw2.classList.add('is-invalid');
          document.getElementById('pwHelp').style.display='block';
        }else{
          pw2.classList.remove('is-invalid');
        }
      }
      form.classList.add('was-validated');
    });
  })();
</script>
</body>
</html>
